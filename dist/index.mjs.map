{"version":3,"sources":["../src/utils/message-utils.ts","../src/constants.ts","../src/store/store-context.tsx","../src/components/MessageNode.tsx","../src/store/canvasStore.ts","../src/components/LMCanvas.tsx","../src/adapters/run-message-interaction.ts","../src/persistence/localStorage.ts","../src/utils/linear-to-graph.ts"],"names":["_a","_b","jsx"],"mappings":"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","file":"index.mjs","sourcesContent":["import type { Message, MessagePartImage, MessagePartToolCall } from \"@/types/message\";\n\nexport function getMessageText(message: Message | null | undefined): string {\n  if (!message) return \"\";\n  const partsText = (message.parts ?? [])\n    .filter((part) => part.type === \"text\")\n    .map((part) => part.text);\n\n  const contentText = typeof message.content === \"string\" ? [message.content] : [];\n\n  return [...contentText, ...partsText].filter(Boolean).join(\"\\n\").trim();\n}\n\nexport function getMessageImages(message: Message | null | undefined): MessagePartImage[] {\n  if (!message) return [];\n  return (message.parts ?? []).filter(\n    (part): part is MessagePartImage => part.type === \"image\",\n  );\n}\n\nexport function getMessageToolCalls(message: Message | null | undefined): MessagePartToolCall[] {\n  if (!message) return [];\n  return (message.parts ?? []).filter(\n    (part): part is MessagePartToolCall => part.type === \"tool-call\",\n  );\n}\n","export const DEFAULT_NODE_WIDTH = 360;\nexport const DEFAULT_NODE_HEIGHT = 200;\nexport const VERTICAL_GAP = 140;\nexport const HORIZONTAL_GAP = 80;\n\nexport const SOURCE_HANDLE_ID = \"source\";\nexport const TARGET_HANDLE_ID = \"target\";\n","import { createContext, useContext } from \"react\";\nimport { useStoreWithEqualityFn } from \"zustand/traditional\";\nimport type { CanvasState, CanvasStore } from \"@/store/canvasStore\";\n\nconst CanvasStoreContext = createContext<CanvasStore | null>(null);\n\nexport const CanvasStoreProvider = CanvasStoreContext.Provider;\n\nexport const useCanvasStore = <T,>(\n  selector: (state: CanvasState) => T,\n  equalityFn?: (a: T, b: T) => boolean,\n): T => {\n  const store = useContext(CanvasStoreContext);\n  if (!store) {\n    throw new Error(\"useCanvasStore must be used within a CanvasStoreProvider\");\n  }\n  return useStoreWithEqualityFn(store, selector, equalityFn);\n};\n\nexport const useCanvasStoreApi = (): CanvasStore => {\n  const store = useContext(CanvasStoreContext);\n  if (!store) {\n    throw new Error(\"useCanvasStoreApi must be used within a CanvasStoreProvider\");\n  }\n  return store;\n};\n","import { memo } from \"react\";\nimport type { NodeProps } from \"reactflow\";\nimport { Handle, Position } from \"reactflow\";\nimport type { CanvasNodeData } from \"@/types/node\";\nimport { getMessageImages, getMessageText, getMessageToolCalls } from \"@/utils/message-utils\";\nimport { SOURCE_HANDLE_ID, TARGET_HANDLE_ID } from \"@/constants\";\nimport { useCanvasStoreApi } from \"@/store/store-context\";\n\nconst MessageNode = ({ id, data, selected }: NodeProps<CanvasNodeData>) => {\n  const store = useCanvasStoreApi();\n  const messages = data.messages ?? [];\n\n  const handleBranch = () => {\n    store.getState().branchNode(id);\n  };\n\n  return (\n    <div\n      style={{\n        width: data.width ?? 360,\n        minHeight: data.height ?? 200,\n        borderRadius: 16,\n        border: selected ? \"2px solid #1F6FEB\" : \"1px solid #1E293B\",\n        background: \"#0B0F1A\",\n        color: \"#E2E8F0\",\n        boxShadow: selected\n          ? \"0 10px 30px rgba(31, 111, 235, 0.35)\"\n          : \"0 8px 24px rgba(15, 23, 42, 0.45)\",\n        padding: 16,\n        display: \"flex\",\n        flexDirection: \"column\",\n        gap: 12,\n      }}\n    >\n      <Handle\n        type=\"target\"\n        position={Position.Top}\n        id={TARGET_HANDLE_ID}\n        style={{ background: \"#38BDF8\", borderRadius: 999 }}\n      />\n\n      <div style={{ display: \"flex\", flexDirection: \"column\", gap: 10 }}>\n        {messages.length === 0 ? (\n          <div style={{ opacity: 0.6, fontSize: 13 }}>No messages yet.</div>\n        ) : (\n          messages.map((message, index) => {\n            const text = getMessageText(message);\n            const images = getMessageImages(message);\n            const toolCalls = getMessageToolCalls(message);\n\n            return (\n              <div\n                key={message.id ?? `${message.role}-${index}`}\n                style={{\n                  borderRadius: 12,\n                  padding: 10,\n                  background: message.role === \"assistant\" ? \"#111827\" : \"#0F172A\",\n                  border: \"1px solid rgba(148, 163, 184, 0.15)\",\n                  display: \"flex\",\n                  flexDirection: \"column\",\n                  gap: 8,\n                }}\n              >\n                <div style={{ fontSize: 12, letterSpacing: 0.4, opacity: 0.7 }}>\n                  {message.role}\n                </div>\n                {text ? (\n                  <div style={{ fontSize: 14, whiteSpace: \"pre-wrap\", lineHeight: 1.5 }}>\n                    {text}\n                  </div>\n                ) : null}\n                {images.length > 0 ? (\n                  <div style={{ display: \"flex\", gap: 8, flexWrap: \"wrap\" }}>\n                    {images.map((imagePart, imgIndex) => (\n                      <img\n                        key={`${imagePart.image}-${imgIndex}`}\n                        src={imagePart.image}\n                        alt={imagePart.alt ?? \"image\"}\n                        style={{\n                          width: 120,\n                          height: 120,\n                          borderRadius: 8,\n                          objectFit: \"cover\",\n                          border: \"1px solid rgba(148, 163, 184, 0.2)\",\n                        }}\n                      />\n                    ))}\n                  </div>\n                ) : null}\n                {toolCalls.length > 0 ? (\n                  <div style={{ fontSize: 12, opacity: 0.7 }}>\n                    Tool calls: {toolCalls.map((call) => call.toolName).join(\", \")}\n                  </div>\n                ) : null}\n              </div>\n            );\n          })\n        )}\n      </div>\n\n      <div style={{ display: \"flex\", justifyContent: \"flex-end\" }}>\n        <button\n          type=\"button\"\n          onClick={handleBranch}\n          style={{\n            padding: \"6px 12px\",\n            borderRadius: 999,\n            border: \"1px solid rgba(148, 163, 184, 0.3)\",\n            background: \"rgba(15, 23, 42, 0.6)\",\n            color: \"#E2E8F0\",\n            fontSize: 12,\n            cursor: \"pointer\",\n          }}\n        >\n          Branch\n        </button>\n      </div>\n\n      <Handle\n        type=\"source\"\n        position={Position.Bottom}\n        id={SOURCE_HANDLE_ID}\n        style={{ background: \"#38BDF8\", borderRadius: 999 }}\n      />\n    </div>\n  );\n};\n\nexport default memo(MessageNode);\n","import { createStore } from \"zustand/vanilla\";\nimport type { StoreApi } from \"zustand\";\nimport {\n  applyEdgeChanges,\n  applyNodeChanges,\n  type Edge,\n  type EdgeChange,\n  type Node,\n  type NodeChange,\n} from \"reactflow\";\nimport type { CanvasNodeData } from \"@/types/node\";\nimport type { Message } from \"@/types/message\";\nimport type { CanvasCamera, CanvasViewSnapshot } from \"@/persistence/types\";\nimport {\n  DEFAULT_NODE_HEIGHT,\n  DEFAULT_NODE_WIDTH,\n  HORIZONTAL_GAP,\n  SOURCE_HANDLE_ID,\n  TARGET_HANDLE_ID,\n  VERTICAL_GAP,\n} from \"@/constants\";\n\nexport type CanvasState = {\n  nodesById: Record<string, Node<CanvasNodeData>>;\n  edges: Edge[];\n  activeNodeId: string | null;\n  camera: CanvasCamera | null;\n  getNode: (id: string) => Node<CanvasNodeData> | undefined;\n  setNodes: (nodes: Node<CanvasNodeData>[]) => void;\n  setEdges: (edges: Edge[]) => void;\n  setActiveNodeId: (nodeId: string | null) => void;\n  setCamera: (camera: CanvasCamera | null) => void;\n  upsertNode: (node: Node<CanvasNodeData>) => void;\n  patchNodeData: (id: string, patch: Partial<CanvasNodeData>) => void;\n  setNodeMessages: (id: string, messages: Message[]) => void;\n  createRootNode: (options?: {\n    id?: string;\n    position?: { x: number; y: number };\n    messages?: Message[];\n  }) => string;\n  branchNode: (\n    parentId: string,\n    options?: {\n      messages?: Message[];\n      position?: { x: number; y: number };\n    },\n  ) => string | null;\n  exportViewSnapshot: (options?: {\n    activeNodeId?: string | null;\n    camera?: CanvasCamera | null;\n  }) => CanvasViewSnapshot;\n  importViewSnapshot: (\n    snapshot: CanvasViewSnapshot,\n    options?: { applyCamera?: boolean; applyActiveNode?: boolean },\n  ) => void;\n  onNodesChange: (changes: NodeChange[]) => void;\n  onEdgesChange: (changes: EdgeChange[]) => void;\n};\n\nexport type CanvasStore = StoreApi<CanvasState>;\n\nconst toNodeMap = (nodes: Node<CanvasNodeData>[]) =>\n  nodes.reduce<Record<string, Node<CanvasNodeData>>>((acc, node) => {\n    acc[node.id] = node;\n    return acc;\n  }, {});\n\nconst createNodeId = () => {\n  if (typeof crypto !== \"undefined\" && \"randomUUID\" in crypto) {\n    return crypto.randomUUID();\n  }\n  return `node-${Math.floor(Math.random() * 1e9)}`;\n};\n\nexport const createCanvasStore = (initial?: {\n  nodes?: Node<CanvasNodeData>[];\n  edges?: Edge[];\n}): CanvasStore =>\n  createStore<CanvasState>((set, get) => ({\n    nodesById: toNodeMap(initial?.nodes ?? []),\n    edges: initial?.edges ?? [],\n    activeNodeId: null,\n    camera: null,\n    getNode: (id) => get().nodesById[id],\n    setNodes: (nodes) => set({ nodesById: toNodeMap(nodes) }),\n    setEdges: (edges) => set({ edges }),\n    setActiveNodeId: (nodeId) => set({ activeNodeId: nodeId }),\n    setCamera: (camera) => set({ camera }),\n    upsertNode: (node) =>\n      set((state) => ({\n        nodesById: {\n          ...state.nodesById,\n          [node.id]: node,\n        },\n      })),\n    patchNodeData: (id, patch) =>\n      set((state) => {\n        const existing = state.nodesById[id];\n        if (!existing) return state;\n        return {\n          nodesById: {\n            ...state.nodesById,\n            [id]: {\n              ...existing,\n              data: {\n                ...existing.data,\n                ...patch,\n              },\n            },\n          },\n        };\n      }),\n    setNodeMessages: (id, messages) =>\n      set((state) => {\n        const existing = state.nodesById[id];\n        if (!existing) return state;\n        return {\n          nodesById: {\n            ...state.nodesById,\n            [id]: {\n              ...existing,\n              data: {\n                ...existing.data,\n                messages,\n              },\n            },\n          },\n        };\n      }),\n    createRootNode: (options) => {\n      const id = options?.id ?? createNodeId();\n      const position = options?.position ?? { x: 0, y: 0 };\n      const node: Node<CanvasNodeData> = {\n        id,\n        type: \"message\",\n        position,\n        data: {\n          status: \"idle\",\n          messages: options?.messages ?? [],\n          width: DEFAULT_NODE_WIDTH,\n          height: DEFAULT_NODE_HEIGHT,\n          parentIds: [],\n          childIds: [],\n          createdAt: new Date().toISOString(),\n        },\n      };\n\n      set((state) => ({\n        nodesById: {\n          ...state.nodesById,\n          [id]: node,\n        },\n      }));\n\n      return id;\n    },\n    branchNode: (parentId, options) => {\n      const parent = get().nodesById[parentId];\n      if (!parent) return null;\n\n      const childId = createNodeId();\n      const existingChildren = parent.data?.childIds ?? [];\n      const childIndex = existingChildren.length;\n\n      const baseX = parent.position.x;\n      const baseY = parent.position.y + (parent.data?.height ?? DEFAULT_NODE_HEIGHT);\n\n      const targetPosition = options?.position ?? {\n        x: baseX + childIndex * (DEFAULT_NODE_WIDTH + HORIZONTAL_GAP),\n        y: baseY + VERTICAL_GAP,\n      };\n\n      const childNode: Node<CanvasNodeData> = {\n        id: childId,\n        type: \"message\",\n        position: targetPosition,\n        data: {\n          status: \"idle\",\n          messages: options?.messages ?? parent.data?.messages ?? [],\n          width: DEFAULT_NODE_WIDTH,\n          height: DEFAULT_NODE_HEIGHT,\n          parentIds: [parentId],\n          childIds: [],\n          createdAt: new Date().toISOString(),\n        },\n      };\n\n      const edge: Edge = {\n        id: `e-${parentId}-${childId}`,\n        source: parentId,\n        target: childId,\n        sourceHandle: SOURCE_HANDLE_ID,\n        targetHandle: TARGET_HANDLE_ID,\n        type: \"default\",\n      };\n\n      set((state) => ({\n        nodesById: {\n          ...state.nodesById,\n          [childId]: childNode,\n          [parentId]: {\n            ...parent,\n            data: {\n              ...parent.data,\n              childIds: [...existingChildren, childId],\n            },\n          },\n        },\n        edges: [...state.edges, edge],\n      }));\n\n      return childId;\n    },\n    exportViewSnapshot: (options) => {\n      const state = get();\n      const nodes = Object.values(state.nodesById);\n      const nodeViews = nodes.reduce<CanvasViewSnapshot[\"nodes\"]>((acc, node) => {\n        acc[node.id] = {\n          id: node.id,\n          x: node.position.x,\n          y: node.position.y,\n          width: node.data?.width,\n          height: node.data?.height,\n        };\n        return acc;\n      }, {});\n\n      return {\n        version: 1,\n        savedAt: new Date().toISOString(),\n        activeNodeId: options?.activeNodeId ?? state.activeNodeId,\n        camera: options?.camera ?? state.camera,\n        nodes: nodeViews,\n      };\n    },\n    importViewSnapshot: (snapshot, options) =>\n      set((state) => {\n        const nextNodesById = { ...state.nodesById };\n\n        Object.entries(snapshot.nodes).forEach(([id, savedNode]) => {\n          const existing = nextNodesById[id];\n          if (!existing) return;\n\n          nextNodesById[id] = {\n            ...existing,\n            position: {\n              x: savedNode.x,\n              y: savedNode.y,\n            },\n            data: {\n              ...existing.data,\n              ...(typeof savedNode.width === \"number\"\n                ? { width: savedNode.width }\n                : {}),\n              ...(typeof savedNode.height === \"number\"\n                ? { height: savedNode.height }\n                : {}),\n            },\n          };\n        });\n\n        return {\n          nodesById: nextNodesById,\n          ...(options?.applyActiveNode === false\n            ? {}\n            : { activeNodeId: snapshot.activeNodeId ?? null }),\n          ...(options?.applyCamera === false\n            ? {}\n            : { camera: snapshot.camera ?? null }),\n        };\n      }),\n    onNodesChange: (changes) =>\n      set((state) => {\n        if (!changes.length) return state;\n        const nodes = Object.values(state.nodesById);\n        const nextNodes = applyNodeChanges(changes, nodes);\n        return { nodesById: toNodeMap(nextNodes) };\n      }),\n    onEdgesChange: (changes) =>\n      set((state) => ({\n        edges: applyEdgeChanges(changes, state.edges),\n      })),\n  }));\n","import { useEffect, useMemo, useRef } from \"react\";\nimport ReactFlow, {\n  Background,\n  BackgroundVariant,\n  type ReactFlowInstance,\n} from \"reactflow\";\nimport MessageNode from \"@/components/MessageNode\";\nimport { CanvasStoreProvider, useCanvasStore } from \"@/store/store-context\";\nimport type { CanvasStore } from \"@/store/canvasStore\";\nimport { createCanvasStore } from \"@/store/canvasStore\";\nimport { DEFAULT_NODE_WIDTH, DEFAULT_NODE_HEIGHT } from \"@/constants\";\n\nexport type LMCanvasProps = {\n  className?: string;\n  store?: CanvasStore;\n  focusNodeId?: string | null;\n  fitView?: boolean;\n};\n\nconst nodeTypes = {\n  message: MessageNode,\n};\n\nconst LMCanvasInner = ({ focusNodeId, fitView }: Pick<LMCanvasProps, \"focusNodeId\" | \"fitView\">) => {\n  const nodes = useCanvasStore((state) => Object.values(state.nodesById));\n  const edges = useCanvasStore((state) => state.edges);\n  const onNodesChange = useCanvasStore((state) => state.onNodesChange);\n  const onEdgesChange = useCanvasStore((state) => state.onEdgesChange);\n  const getNode = useCanvasStore((state) => state.getNode);\n  const camera = useCanvasStore((state) => state.camera);\n  const setCamera = useCanvasStore((state) => state.setCamera);\n  const setActiveNodeId = useCanvasStore((state) => state.setActiveNodeId);\n\n  const reactFlowRef = useRef<ReactFlowInstance | null>(null);\n\n  useEffect(() => {\n    if (!camera || !reactFlowRef.current) return;\n\n    const current = reactFlowRef.current.getViewport();\n    const isSame =\n      Math.abs(current.x - camera.x) < 0.5 &&\n      Math.abs(current.y - camera.y) < 0.5 &&\n      Math.abs(current.zoom - camera.zoom) < 0.001;\n\n    if (isSame) return;\n\n    reactFlowRef.current.setViewport(\n      { x: camera.x, y: camera.y, zoom: camera.zoom },\n      { duration: 0 },\n    );\n  }, [camera]);\n\n  useEffect(() => {\n    if (!focusNodeId) return;\n    const node = getNode(focusNodeId);\n    if (!node || !reactFlowRef.current) return;\n\n    const width = node.data?.width ?? DEFAULT_NODE_WIDTH;\n    const height = node.data?.height ?? DEFAULT_NODE_HEIGHT;\n    const centerX = node.position.x + width / 2;\n    const centerY = node.position.y + height / 2;\n\n    reactFlowRef.current.setCenter(centerX, centerY, {\n      zoom: 1.05,\n      duration: 200,\n    });\n  }, [focusNodeId, getNode]);\n\n  return (\n    <ReactFlow\n      nodes={nodes}\n      edges={edges}\n      onNodesChange={onNodesChange}\n      onEdgesChange={onEdgesChange}\n      nodeTypes={nodeTypes}\n      fitView={fitView}\n      onInit={(instance) => {\n        reactFlowRef.current = instance;\n      }}\n      onMoveEnd={(_, viewport) => {\n        setCamera({\n          x: viewport.x,\n          y: viewport.y,\n          zoom: viewport.zoom,\n        });\n      }}\n      onNodeClick={(_, node) => {\n        setActiveNodeId(node.id);\n      }}\n    >\n      <Background variant={BackgroundVariant.Dots} gap={24} size={1} />\n    </ReactFlow>\n  );\n};\n\nconst LMCanvas = ({ className, store, focusNodeId, fitView = true }: LMCanvasProps) => {\n  const defaultStore = useMemo(() => createCanvasStore(), []);\n  const activeStore = store ?? defaultStore;\n\n  return (\n    <div className={className} style={{ width: \"100%\", height: \"100%\" }}>\n      <CanvasStoreProvider value={activeStore}>\n        <LMCanvasInner focusNodeId={focusNodeId ?? null} fitView={fitView} />\n      </CanvasStoreProvider>\n    </div>\n  );\n};\n\nexport default LMCanvas;\n","import type { CanvasStore } from \"@/store/canvasStore\";\nimport type { Message } from \"@/types/message\";\nimport type { ChatStatus, MessageAdapter, SendMessageInput } from \"@/adapters/types\";\n\nexport type RunMessageInteractionInput = SendMessageInput & {\n  store: CanvasStore;\n  adapter: MessageAdapter;\n  optimistic?: boolean;\n  syncOnComplete?: boolean;\n};\n\nexport type RunMessageInteractionResult = {\n  status: ChatStatus;\n  messages: Message[];\n};\n\nconst isAsyncIterable = <T,>(value: unknown): value is AsyncIterable<T> =>\n  typeof value === \"object\" &&\n  value !== null &&\n  Symbol.asyncIterator in (value as Record<PropertyKey, unknown>);\n\nconst mergeMessage = (existing: Message, incoming: Message): Message => ({\n  ...existing,\n  ...incoming,\n  parts: incoming.parts ?? existing.parts,\n  content: incoming.content ?? existing.content,\n});\n\nconst upsertMessage = (messages: Message[], next: Message): Message[] => {\n  if (next.id) {\n    const existingIndex = messages.findIndex((message) => message.id === next.id);\n    if (existingIndex >= 0) {\n      const copy = [...messages];\n      copy[existingIndex] = mergeMessage(copy[existingIndex], next);\n      return copy;\n    }\n  }\n\n  return [...messages, next];\n};\n\nconst appendIfMissingById = (messages: Message[], next: Message): Message[] => {\n  if (!next.id) return [...messages, next];\n  if (messages.some((message) => message.id === next.id)) return messages;\n  return [...messages, next];\n};\n\nconst getNodeMessages = (store: CanvasStore, nodeRef: string): Message[] => {\n  const node = store.getState().getNode(nodeRef);\n  return node?.data?.messages ?? [];\n};\n\nexport const runMessageInteraction = async (\n  input: RunMessageInteractionInput,\n): Promise<RunMessageInteractionResult> => {\n  const {\n    store,\n    adapter,\n    nodeRef,\n    message,\n    parentNodeRef,\n    metadata,\n    optimistic = true,\n    syncOnComplete = true,\n  } = input;\n\n  const existingNode = store.getState().getNode(nodeRef);\n  if (!existingNode) {\n    throw new Error(`runMessageInteraction: node \"${nodeRef}\" not found`);\n  }\n\n  try {\n    store.getState().patchNodeData(nodeRef, { status: \"loading\" });\n\n    if (optimistic) {\n      const baseMessages = getNodeMessages(store, nodeRef);\n      const nextMessages = appendIfMissingById(baseMessages, message);\n      store.getState().setNodeMessages(nodeRef, nextMessages);\n    }\n\n    const response = adapter.sendMessage({\n      nodeRef,\n      message,\n      parentNodeRef,\n      metadata,\n    });\n\n    if (isAsyncIterable<Message>(response)) {\n      for await (const streamedMessage of response) {\n        const current = getNodeMessages(store, nodeRef);\n        const nextMessages = upsertMessage(current, streamedMessage);\n        store.getState().setNodeMessages(nodeRef, nextMessages);\n      }\n    } else {\n      await response;\n    }\n\n    if (syncOnComplete) {\n      const canonicalMessages = adapter.getMessages(nodeRef);\n      if (canonicalMessages.length > 0) {\n        store.getState().setNodeMessages(nodeRef, canonicalMessages);\n      }\n    }\n\n    store.getState().patchNodeData(nodeRef, { status: \"completed\" });\n    const finalMessages = getNodeMessages(store, nodeRef);\n    return { status: \"completed\", messages: finalMessages };\n  } catch (error) {\n    store.getState().patchNodeData(nodeRef, { status: \"error\" });\n    adapter.onError?.(error, nodeRef);\n    throw error;\n  }\n};\n","import type { CanvasViewSnapshot, PersistenceAdapter } from \"@/persistence/types\";\n\ntype LocalStoragePersistenceOptions = {\n  keyPrefix?: string;\n  storage?: Storage;\n};\n\nconst DEFAULT_PREFIX = \"lmcanvas:view:\";\n\nconst safeParse = (raw: string | null): CanvasViewSnapshot | null => {\n  if (!raw) return null;\n\n  try {\n    const parsed = JSON.parse(raw) as CanvasViewSnapshot;\n    if (!parsed || parsed.version !== 1 || typeof parsed.nodes !== \"object\") {\n      return null;\n    }\n    return parsed;\n  } catch {\n    return null;\n  }\n};\n\nconst resolveStorage = (explicitStorage?: Storage): Storage | null => {\n  if (explicitStorage) return explicitStorage;\n  if (typeof window === \"undefined\") return null;\n\n  try {\n    return window.localStorage;\n  } catch {\n    return null;\n  }\n};\n\nexport const createLocalStoragePersistenceAdapter = (\n  options?: LocalStoragePersistenceOptions,\n): PersistenceAdapter => {\n  const prefix = options?.keyPrefix ?? DEFAULT_PREFIX;\n\n  return {\n    load: (key) => {\n      const storage = resolveStorage(options?.storage);\n      if (!storage) return null;\n      return safeParse(storage.getItem(`${prefix}${key}`));\n    },\n    save: (key, snapshot) => {\n      const storage = resolveStorage(options?.storage);\n      if (!storage) return;\n      storage.setItem(`${prefix}${key}`, JSON.stringify(snapshot));\n    },\n    clear: (key) => {\n      const storage = resolveStorage(options?.storage);\n      if (!storage) return;\n      storage.removeItem(`${prefix}${key}`);\n    },\n  };\n};\n","import type { Edge, Node } from \"reactflow\";\nimport {\n  DEFAULT_NODE_HEIGHT,\n  DEFAULT_NODE_WIDTH,\n  SOURCE_HANDLE_ID,\n  TARGET_HANDLE_ID,\n  VERTICAL_GAP,\n} from \"@/constants\";\nimport type { Message } from \"@/types/message\";\nimport type { CanvasNodeData } from \"@/types/node\";\n\nexport type BuildLinearGraphOptions = {\n  startX?: number;\n  startY?: number;\n  verticalGap?: number;\n  nodeWidth?: number;\n  nodeHeight?: number;\n  idPrefix?: string;\n};\n\nexport type LinearGraph = {\n  nodes: Node<CanvasNodeData>[];\n  edges: Edge[];\n  rootNodeId: string;\n  lastNodeId: string;\n};\n\nconst toTurns = (messages: Message[]): Message[][] => {\n  if (!messages.length) return [[]];\n\n  const turns: Message[][] = [];\n  const running: Message[] = [];\n\n  messages.forEach((message, index) => {\n    running.push(message);\n    const isAssistant = message.role === \"assistant\";\n    const isLast = index === messages.length - 1;\n\n    if (isAssistant || isLast) {\n      turns.push([...running]);\n    }\n  });\n\n  return turns;\n};\n\nconst buildUniqueNodeId = (\n  desired: string,\n  existing: Set<string>,\n): string => {\n  if (!existing.has(desired)) {\n    existing.add(desired);\n    return desired;\n  }\n\n  let suffix = 1;\n  let next = `${desired}-${suffix}`;\n  while (existing.has(next)) {\n    suffix += 1;\n    next = `${desired}-${suffix}`;\n  }\n  existing.add(next);\n  return next;\n};\n\nexport const buildLinearGraphFromMessages = (\n  messages: Message[],\n  options?: BuildLinearGraphOptions,\n): LinearGraph => {\n  const nodeWidth = options?.nodeWidth ?? DEFAULT_NODE_WIDTH;\n  const nodeHeight = options?.nodeHeight ?? DEFAULT_NODE_HEIGHT;\n  const startX = options?.startX ?? 0;\n  const startY = options?.startY ?? 0;\n  const verticalGap = options?.verticalGap ?? VERTICAL_GAP;\n  const idPrefix = options?.idPrefix ?? \"linear-node\";\n\n  const turns = toTurns(messages);\n  const nodes: Node<CanvasNodeData>[] = [];\n  const edges: Edge[] = [];\n  const usedIds = new Set<string>();\n\n  for (let index = 0; index < turns.length; index += 1) {\n    const turnMessages = turns[index];\n    const lastMessage = turnMessages[turnMessages.length - 1];\n    const seedId = lastMessage?.id\n      ? `${idPrefix}-${lastMessage.id}`\n      : `${idPrefix}-${index}`;\n    const nodeId = buildUniqueNodeId(seedId, usedIds);\n\n    const parentNodeId = nodes[index - 1]?.id;\n\n    nodes.push({\n      id: nodeId,\n      type: \"message\",\n      position: {\n        x: startX,\n        y: startY + index * (nodeHeight + verticalGap),\n      },\n      data: {\n        status: \"idle\",\n        messages: turnMessages,\n        width: nodeWidth,\n        height: nodeHeight,\n        parentIds: parentNodeId ? [parentNodeId] : [],\n        childIds: [],\n        createdAt: new Date().toISOString(),\n      },\n    });\n\n    if (parentNodeId) {\n      edges.push({\n        id: `e-${parentNodeId}-${nodeId}`,\n        source: parentNodeId,\n        target: nodeId,\n        sourceHandle: SOURCE_HANDLE_ID,\n        targetHandle: TARGET_HANDLE_ID,\n        type: \"default\",\n      });\n\n      const previousNode = nodes[index - 1];\n      previousNode.data = {\n        ...previousNode.data,\n        childIds: [nodeId],\n      };\n    }\n  }\n\n  const rootNodeId = nodes[0]?.id ?? \"\";\n  const lastNodeId = nodes[nodes.length - 1]?.id ?? \"\";\n\n  return {\n    nodes,\n    edges,\n    rootNodeId,\n    lastNodeId,\n  };\n};\n"]}